(async()=>{let startPepperActivitySoundAsync,stopPepperActivitySoundAsync;const getCurrentTimeFormatted=()=>{const e=new Date;let t=e.getHours();const i=e.getMinutes(),n=e.getSeconds(),s=e.getFullYear().toString().slice(-2),a=t>=12?"pm":"am";return t%=12,t=t||12,`${e.getMonth()+1}/${e.getDate()}/${s} ${t}:${i<10?"0"+i:i}:${n<10?"0"+n:n}${a}`},safeSerializeAny=e=>{try{return"function"==typeof e?"[Function]":"symbol"==typeof e?e.toString():"bigint"==typeof e?e.toString()+"n":"object"==typeof e?JSON.stringify(e,(e,t)=>"function"==typeof t?"[Function]":"symbol"==typeof t?t.toString():"bigint"==typeof t?t.toString()+"n":t,2):String(e)}catch(e){return`[Serialization Error: ${e.message}]`}};class STTWidget{static speechCompleteBaseDelayDurationMs=1e3;static noSpeechError="no-speech";constructor(e){this.widgetEle=null,this.finalizedTranscriptsEle=null,this.interimTranscriptEle=null,this.toolbarEle=null,this.recognitionObjs=[],this.currentRecognitionIdx=0,this.finalTranscript="",this.speechCompleteTimerId=null,this.rejectWithoutSpeechContent=null,this.anyUnfinalizedTranscript="",this.alreadyQuietedForThisSession=!1,this.initializedListeners=!1,this.unmuteTriggers=["unmute","on mute","on-mute","Unmute","On mute","On-mute"],this.onUserSpeechPhraseFinishAsync=e.onUserSpeechPhraseFinishAsync,this.onUserSpeechPhraseStartAsync=e.onUserSpeechPhraseStartAsync,this.beginMonitoringForUmms=Mine.noop,this.ceaseMonitoringForUmms=Mine.noop,this.lastUserSoundDetectedTimeMs=Date.now(),this.useNoiseDetection=!1!==e.useNoiseDetection,this.mode=e.mode,this.speakOutput=e.speakOutput,this.startMinimized=e.startMinimized,this.lastSentMsgInterimText="",this.lastSentMsgSentTimeMs=null,this.sessionStartTime=Date.now(),this.spokenRichPhrases=[],this.lastPhraseStartTimestampMs=null}#e(){let e=!1;navigator.mediaDevices.getUserMedia({audio:!0}).then(async t=>{t=await STTWidget.switchToAirPodsIfAvailableAsync(t),audioContext=new AudioContext;const i=audioContext.createAnalyser();audioContext.createMediaStreamSource(t).connect(i),i.fftSize=2048;const n=i.fftSize,s=new Uint8Array(n);setInterval(()=>{if(!e)return;i.getByteTimeDomainData(s);let t=0;for(let e=0;e<n;e++){let i=s[e]/128-1;t+=i*i}Math.sqrt(t/n)>=.03&&(this.lastUserSoundDetectedTimeMs=Date.now())},100)}).catch(e=>{Mine.toastError("Couldn't start to mic activity detection"),console.error(e)}),this.beginMonitoringForUmms=()=>e=!0,this.ceaseMonitoringForUmms=()=>e=!1}async initListeningForeverAsync(){for(this.isDestroyed=!1,this.useNoiseDetection&&this.#e();!this.isDestroyed;)await this.#t().catch(e=>console.log(e)),await Mine.sleep(500)}async dieAsync(){this.#i(),this.recognitionObjs.forEach(e=>e.abort()),clearTimeout(this.speechCompleteTimerId),this.speechCompleteTimerId=null,this.ceaseMonitoringForUmms(),this.widgetEle&&(this.widgetEle.remove(),this.widgetEle=null),this.isDestroyed=!0}static async switchToAirPodsIfAvailableAsync(e){if(MineTm.isMobile)return e;const t=(await navigator.mediaDevices.enumerateDevices()).find(e=>"audioinput"===e.kind&&e.label.toLowerCase().includes("airpods")&&!e.label.toLowerCase().startsWith("default"));return t?(e.getTracks().forEach(e=>e.stop()),await navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t.deviceId}}})):e}async#t(){return new Promise((e,t)=>{this.rejectWithoutSpeechContent=t,this.finalTranscript="",this.alreadyQuietedForThisSession=!1,this.speechCompleteTimerId=null,this.lastPhraseStartTimestampMs=null,this.#n(),this.recognitionObjs.length||this.#s(),this.initializedListeners||(document.addEventListener("FakeSpeechContextText",e=>{this.isDestroyed||this.#a(e.detail.text)}),this.initializedListeners=!0),this.#o()})}#s(){this.recognitionObjs=[new webkitSpeechRecognition,new webkitSpeechRecognition];const e=this.#r();this.recognitionObjs.forEach((t,i)=>{t.interimResults=!0,t.continuous=!0,t.maxAlternatives=1,t.lang="en-US",t.recognitionIdx=i,Object.assign(t,e)})}#a(e){this.ceaseMonitoringForUmms(),this.finalTranscript="",this.finalizedTranscriptsEle.textContent="",this.interimTranscriptEle.textContent="",this.alreadyQuietedForThisSession=!1;const t=this.spokenRichPhrases.length?[...this.spokenRichPhrases]:null;this.spokenRichPhrases=[],document.title=".",this.onUserSpeechPhraseFinishAsync({text:e,richPhrases:t,lastPhraseStartTimestampMs:this.lastPhraseStartTimestampMs})}getNetSpokenCompiled(){return`${this.finalTranscript}\n${this.anyUnfinalizedTranscript}`.trim()}#r(){const e="⡀⣀⣄⣤⣦⣶⣷⣿";return{onstart:e=>{this.interimTranscriptEle.textContent=""},onresult:t=>{if(this.isDestroyed)return;if(t.currentTarget.recognitionIdx!==this.currentRecognitionIdx)return;const i=this.getNetSpokenCompiled();let n="",s=!1,a=!1;for(let e=t.resultIndex;e<t.results.length;++e){const i=t.results[e],{transcript:o}=i[0],r=o.trim();if(i.isFinal){s=!0,this.finalTranscript+=(this.finalTranscript?"\n":"")+r,this.finalizedTranscriptsEle.textContent=this.finalTranscript;const e=Date.now(),t={text:r,relativeMaybeStartTimestampMs:this.lastPhraseStartTimestampMs-this.sessionStartTime,relativeEndTimestampMs:e-this.sessionStartTime,confidence:i[0].confidence||null};t.confidence&&t.confidence<.9&&i.length>1&&(t.alternatives=Array.from(i).slice(1,3).map(e=>({text:e.transcript||"",confidence:e.confidence||null})).filter(e=>e.text)),this.spokenRichPhrases.push(t),this.lastPhraseStartTimestampMs=null,MineTm.liveMode.isCallMuted&&this.unmuteTriggers.includes(r)&&(a=!0)}else n+=r+" "}if(n&&!this.lastPhraseStartTimestampMs&&(this.lastPhraseStartTimestampMs=Date.now()),this.interimTranscriptEle.textContent=n,this.widgetEle.scrollTop=this.widgetEle.scrollHeight,MineTm.liveMode.isCallMuted)return a&&MineTm.liveMode.toggleMuteAsync(),this.finalTranscript="",void(this.finalizedTranscriptsEle.textContent=this.finalTranscript);if(!this.alreadyQuietedForThisSession&&this.finalTranscript&&!n)return this.finalTranscript="",void(this.finalizedTranscriptsEle.textContent=this.finalTranscript);this.anyUnfinalizedTranscript=s?"":n;const o=this.getNetSpokenCompiled(),r=o.trim().split("\n").join(" ").split(" ").length;if(MineTm.isMobile||(document.title=(t=>{if(t<=0)return"";const i=Math.floor((t-1)/8),n=(t-1)%8;return e[7].repeat(i)+(n>=0?e[n]:"")})(r)),(!i||r%2)&&this.onUserSpeechPhraseStartAsync(),!this.alreadyQuietedForThisSession&&r&&(MineTmAudio.speechAudio.pause(),MineTmAudio.stopLocalSpeaking(),this.alreadyQuietedForThisSession=!0),this.beginMonitoringForUmms(),null==this.speechCompleteTimerId||!s&&i!==o){clearTimeout(this.speechCompleteTimerId),this.speechCompleteTimerId=null;let e=STTWidget.speechCompleteBaseDelayDurationMs;PHRASES.quickResponsePhrasesLower.includes(o.toLowerCase())?e=500:(o.length>30&&(e+=1e3*Math.floor(o.length/120)),e=Math.min(e,2e3));const t=()=>{const i=!!MineTm.getAllResponseBlocks().at(-1)?.querySelector('[data-element-id="user-message"]'),n=e+(i?1e3:0),s=Date.now()-this.lastUserSoundDetectedTimeMs;if(!(s>n)){const e=Math.max(n-s,500);return void(this.speechCompleteTimerId=setTimeout(t,e))}let a=o;this.lastSentMsgInterimText&&a.toLowerCase().startsWith(this.lastSentMsgInterimText.toLowerCase())&&this.lastSentMsgInterimText.split(" ").length>=3&&a.length>this.lastSentMsgInterimText.length&&Date.now()-this.lastSentMsgSentTimeMs<1e4&&(a=a.slice(this.lastSentMsgInterimText.length)),this.speechCompleteTimerId=null,this.lastSentMsgSentTimeMs=Date.now(),this.lastSentMsgInterimText=this.anyUnfinalizedTranscript,this.anyUnfinalizedTranscript="",this.#a(a)};this.speechCompleteTimerId=setTimeout(t,e)}},onend:async e=>{this.#c().stop(),this.isDestroyed||await this.#l()},onerror:async e=>{if(console.log("[STT] onerror"),"audio-capture"===e.error&&await Mine.sleep(1e3),e.error!==STTWidget.noSpeechError)return MineTm.isMobile&&"aborted"===e.error&&!this.getNetSpokenCompiled()||Mine.toastError(`[STT]: ${e.error}`),"aborted"===e.error||"network"===e.error?(await Mine.sleep(1e3),void this.#i()):void this.rejectWithoutSpeechContent(new Error(`Speech recognition error: ${e.error}`));this.#c().stop()}}}#o(){this.#c().start()}async#l(){this.#c().stop(),this.#d(),MineTm.isMobile&&await Mine.sleep(100);try{this.#o()}catch(e){this.rejectWithoutSpeechContent(e)}}#c(){return this.recognitionObjs[this.currentRecognitionIdx]}#d(){this.currentRecognitionIdx=(this.currentRecognitionIdx+1)%this.recognitionObjs.length}#i(){this.recognitionObjs.forEach(e=>e.stop())}#n(){if(this.widgetEle)return this.finalizedTranscriptsEle.textContent="",this.interimTranscriptEle.textContent="",void this.widgetEle.classList.toggle("on",!0);Mine.isi(Mine.normalizeSpaceIndents(`\n      .MineSttWidget {\n        opacity: 0;\n        pointer-events: none;\n        transition: all 0.2s, height 0.3s, width 0.3s;\n        position: fixed;\n        bottom: 0;\n        width: 100%;\n        overflow: auto;\n        background-color: rgb(30,30,30);\n        border-top: 1px solid rgb(90,90,90);\n        border-radius: 8px 8px 0 0;\n        font-family: monospace;\n        font-size: 14px;\n        z-index: 50;\n        white-space: pre-wrap;\n        color: #222;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.2);\n      }\n      .MineSttWidget.minimized {\n        width: 35px;\n        height: 35px;\n        border-radius: 0 100px 0 0;\n        overflow: hidden;\n      }\n      .MineSttWidget.on {\n        opacity: 1;\n        pointer-events: auto;\n      }\n      .MineSttWidget-content-wrapper:not(:has(.MineSttWidget-unminimizer.visible)) {\n        padding: 15px;\n      }\n      .MineSttWidget-unminimizer {\n        top: 0;\n        left: 0;\n        height: 35px;\n        width: 100%;\n        background: transparent;\n        color: white;\n        display: none;\n        font-weight: 500;\n      }\n      .MineSttWidget-unminimizer.visible {\n        display: block;\n      }\n      .MineSttWidget-unminimizer span {\n        position: absolute;\n        bottom: 4px;\n        left: 9px;\n      }\n      .MineSttWidget-transcripts {\n        max-height: 0;\n        overflow: hidden;\n        transition: all 0.2s;\n      }\n      .MineSttWidget-transcripts.visible {\n        max-height: 1000px;\n        overflow: auto;\n      }\n      .MineSttWidget-interimTranscripts {\n        color: white;\n        font-style: italic;\n        margin-bottom: 10px;\n      }\n      .MineSttWidget-interimTranscripts:empty::before {\n        content: '*';\n      }\n      .MineSttWidget-finalizedTranscripts {\n        margin-bottom: 10px;\n        color: darkgray;\n        font-weight: 500;\n        max-height: 300px;\n        overflow: auto;\n        transition: all 0.2s;\n      }\n      .MineSttWidget-finalizedTranscripts:empty {\n        max-height: 0;\n        margin-bottom: 0;\n        opacity: 0;\n      }\n      \n      .MineSttWidget-transcripts:has(> .MineSttWidget-finalizedTranscripts:not(:empty)) > .MineSttWidget-interimTranscripts:empty {\n        display: none;\n      }\n      .MineSttWidget-toolbar {\n        color: white;\n        text-align: center;\n        padding-bottom: ${MineTm.isMobile?"15px":"0"};\n      }\n      .MineSttWidget-toolbar button {\n        padding: 2px 5px 0;\n        min-width: 28px;\n        min-height: 28px;\n        border-radius: 5px;\n        margin: 0 2px;\n        transition: all 0.2s;\n        outline: none;\n        border: 1px solid transparent;\n      }\n      ${MineTm.isMobile?"":"\n      .MineSttWidget-toolbar button:hover {\n        background: rgba(100,100,100,0.4);\n      }\n      "}\n      .MineSttWidget-toolbar button.active {\n        border: 1px solid gray;\n      }\n      .MineSttWidget-input-wrapper {\n        margin-top: 10px;\n        width: 100%;\n        text-align: center;\n        max-height: 0;\n        padding: 0;\n        overflow: hidden;\n        transition: all 0.2s;\n      }\n      .MineSttWidget-input-wrapper.visible {\n        max-height: 1000px;\n        opacity: 1;\n      }\n      .MineSttWidget-duration {\n        margin-left: 10px;\n        cursor: default;\n      }\n\n      \n      .MineSttWidget-content-wrapper:has(.MineSttWidget-unminimizer.visible) >div {display: none;}\n      `)),this.widgetEle=document.createElement("div"),this.widgetEle.className="MineSttWidget"+(this.startMinimized?" minimized":""),this.startMinimized&&(this.widgetEle.style.display="none");const e=document.createElement("div");e.className="MineSttWidget-content-wrapper",!MineTm.isMobile&&Mine.quietElement(e,{hoverDelayMs:0}),this.widgetEle.appendChild(e),this.minimizeButttonEle=document.createElement("button"),this.minimizeButttonEle.className="MineSttWidget-unminimizer"+(this.startMinimized?" visible":""),this.minimizeButttonEle.innerHTML="<span>↗</span>",this.minimizeButttonEle.title="Unminimize Speech widget",this.minimizeButttonEle.addEventListener("click",()=>Mine.qs("#mineToggleWidgetMinimization").click()),e.appendChild(this.minimizeButttonEle),this.transcriptsEle=document.createElement("div"),this.transcriptsEle.className="MineSttWidget-transcripts visible",this.finalizedTranscriptsEle=document.createElement("div"),this.finalizedTranscriptsEle.className="MineSttWidget-finalizedTranscripts",this.transcriptsEle.appendChild(this.finalizedTranscriptsEle),this.interimTranscriptEle=document.createElement("div"),this.interimTranscriptEle.className="MineSttWidget-interimTranscripts",this.transcriptsEle.appendChild(this.interimTranscriptEle),e.appendChild(this.transcriptsEle),MineTm.getTaAsync().then(t=>{const i=t.offsetWidth;i<100||i<e.offsetWidth&&(e.style.maxWidth=`${i}px`,e.style.margin="0 auto")}),this.toolbarEle=document.createElement("div"),this.toolbarEle.className="MineSttWidget-toolbar";const t={mineToggleAiSpeechVisibility:{label:"👁️‍🗨️",title:"Toggle speech-out controls visibility",activeOnStart:getIsSpeechOutVisible(),onclick:async e=>toggleSpeechOutVisibility()},mineToggleMySpeechTranscriptsVisibility:{label:"💬",title:"Toggle my speech transcripts visibility",activeOnStart:!0,onclick:async e=>{const t=e.currentTarget,i=!t.classList.contains("active");t.classList.toggle("active",i),Mine.qs(".MineSttWidget-transcripts").classList.toggle("visible",i)}},mineToggleWidgetMinimization:{label:"↙️",title:"Toggle Widget Minimization",activeOnStart:!1,onclick:async e=>{const t=e.currentTarget,i=!t.classList.contains("active");t.classList.toggle("active",i),Mine.qs(".MineSttWidget").classList.toggle("minimized",i),Mine.qs(".MineSttWidget-unminimizer").classList.toggle("visible",i)}},"separator-0":{},mineToggleKeyboardButton:{label:"📝",title:"Toggle Keyboard input",activeOnStart:!1,onclick:async e=>{const t=e.currentTarget,i=t.classList.contains("active"),n=Mine.qs(".MineSttWidget-input-wrapper"),s=!i;t.classList.toggle("active",s),n.classList.toggle("visible",s),!MineTm.isMobile&&s&&n.querySelector("textarea")?.focus()}},mineJamieModeStatusButton:{label:"🧑🏻‍💻",title:"Toggle Jamie",activeOnStart:!1,onclick:async e=>{e.currentTarget.classList.contains("active")?jamie.disablePassiveMonitoring():jamie.enablePassiveMonitoring()}},mineMuteStatusButton:{label:"🎙️",title:"Toggle mute",activeOnStart:!0,onclick:async()=>await MineTm.liveMode.toggleMuteAsync()}},i=Object.entries(t).map(([e,t])=>e.startsWith("separator-")?'<span style="margin: 0 10px;color: gray;cursor: default;">/</span>':`<button id="${e}" class="${t.activeOnStart?"active":""}" title="${t.title||""}">${t.label}</button>`).join("");this.toolbarEle.innerHTML=`${i}<span class='MineSttWidget-duration'></span>`.trim(),e.appendChild(this.toolbarEle),Object.entries(t).filter(([e])=>!e.startsWith("separator-")).forEach(([e,t])=>this.toolbarEle.querySelector(`#${e}`).addEventListener("click",t.onclick)),this.inputSection=document.createElement("div"),this.inputSection.className="MineSttWidget-input-wrapper",this.inputSection.innerHTML=Mine.normalizeSpaceIndents('\n      <textarea id="override_text"\n        style="\n          width: 100%;\n          height: 200px;\n          border-radius:4px;\n          padding:8px;\n          background: rgba(255,255,255,0.05);\n          font-size: 16px; \n          color: white;"\n        placeholder="Message"></textarea>\n      <button id="override_send"\n        style="\n          display:block;\n          margin:0 auto;\n          padding:5px 15px;\n          background:gray;\n          border:none;\n          color:white;\n          transition: background 0.2s;\n          border-radius:4px;">Send</button>\n      ').trim(),e.appendChild(this.inputSection),document.body.appendChild(this.widgetEle),renderMuteStatus();const n=Date.now(),s=()=>{if(this.isDestroyed)return;const e=Math.floor((Date.now()-n)/1e3),t=Math.floor(e/3600),i=Math.floor(e%3600/60);Mine.qs(".MineSttWidget-duration").textContent=t>0?`${t}h${i}m`:`${i}m`};setInterval(s,6e4),s();const a=Mine.qs("#override_send"),o=Mine.qs("#override_text"),r=()=>o.value.trim();Mine.bindHotkey("metaKey+enter",o,()=>a.click()),o.addEventListener("input",e=>{const t=r();a.style.background=t?"#007AFF":"gray"}),a.addEventListener("click",()=>{const e=r();e&&(Mine.updateReactTypableFormValue(o,""),document.dispatchEvent(new CustomEvent("FakeSpeechContextText",{detail:{text:e}})))}),jamie?.updateOverlayIcon(),setTimeout(()=>{this.widgetEle.classList.toggle("on",!0)},10)}}const Plugins={getRecentCalendarEventsAsync:async()=>{const e=await MineTm.getMinePluginBasedSecretAsync("jamieTmMinePepperKey");if(!e)throw"Error: invalid api key";return await CalendarMonitor.getRecentCalendarEventsAsync(e)},getCurrentChatStatsAsync:async()=>{const{idbe:e}=await MineTm.getCurrentChatIdbMetaAsync(),t={modelId:e.modelInfo.id,numMessages:e.messages.length,aiContextSize:e.chatParams.contextLimit,engagedDuration:MineTm.getChatEngagedDurationLabel(e),thinkEffort:e.chatParams?.reasoningEffort,promptCachingEnabled:e.chatParams.promptCachingEnabled,netChatCostDollars:e.tokenUsage?.totalCostUSD};return await MineTm.simulateAddFileAttachment(JSON.stringify(t,null,2),"jamie-current-chat-stats.json"),"Success. Data file has been attached to the chat and will automatically be sent along with your response. Please notify the client to check the attachment."},getContextFromAChat:async(e=[])=>{const t=await MineTm.getContextAboutTopic(e);if(t){const e="jamie-context-search-result.txt";return await MineTm.simulateAddFileAttachment(t.attachment.text,e),`Entry found from ${new Date(t.createdAt)} titled "${t.attachment.name}". It has been attached to the chat and will automatically be sent along with your response. Please notify the client about its date and to check the attachment.`}return"No data was found within those parameters. Please notify the client exactly what parameters were used, and inform them that only attachment titles are searched."},getWebpageTextAsync:async({url:e})=>{const t=new AbortController,i=setTimeout(()=>t.abort(),5e3);try{const i=await MineTm.getMinePluginBasedSecretAsync("scrapingFishKey");if(!i)return"no api key found";const n=`https://scraping.narf.ai/api/v1/?api_key=${i}&url=${encodeURIComponent(e)}`,s=`https://proxy-mine.fly.dev/?url=${encodeURIComponent(n)}`,a=await fetch(s,{signal:t.signal});if(!a.ok)throw new Error(`HTTP ${a.status}`);const o=await a.text();return o.length>3e6?`Error: HTML too large (${(o.length/1e6).toFixed(1)}MB)`:convertToMarkdownLike(o)}catch(e){return console.error("Failed to fetch from ScrapingFish:",e),"[error loading page]"}finally{clearTimeout(i)}}},convertToMarkdownLike=e=>{const t=(new DOMParser).parseFromString(e,"text/html");if(!t||!t.body)return"Error: Failed to parse HTML document";const i=t.body;["script","style","noscript","iframe","object","embed","header","footer","nav","aside","menu",'[role="navigation"]','[role="complementary"]','[class*="header"]','[class*="footer"]','[class*="nav"]','[class*="sidebar"]','[class*="aside"]','[class*="widget"]','[class*="advertisement"]','[class*="ad-"]','[id*="header"]','[id*="footer"]','[id*="nav"]','[id*="menu"]','[id*="sidebar"]','[id*="aside"]','[id*="social"]','[class*="cookie"]','[class*="popup"]','[class*="modal"]','[class*="newsletter"]','[class*="subscribe"]'].forEach(e=>{try{t.querySelectorAll(e).forEach(e=>{e===i||e.contains(i)||e.remove()})}catch(e){}});const n=document.createElement("div");return n.innerHTML=t.body.innerHTML,["h1","h2","h3","h4","h5","h6"].forEach((e,t)=>{n.querySelectorAll(e).forEach(e=>{const i="#".repeat(t+1);e.insertAdjacentText("afterbegin",`${i} `),e.insertAdjacentText("beforeend","\n\n")})}),n.querySelectorAll("p").forEach(e=>{e.insertAdjacentText("beforeend","\n\n")}),n.querySelectorAll("ul, ol").forEach(e=>{e.querySelectorAll("li").forEach(t=>{t.insertAdjacentText("afterbegin","UL"===e.tagName?"- ":"* "),t.insertAdjacentText("beforeend","\n")}),e.insertAdjacentText("beforeend","\n")}),n.querySelectorAll("a").forEach(e=>{const t=e.textContent.trim(),i=e.getAttribute("href")||"";if(t&&i){const n=document.createTextNode(`[${t}](${i})`);e.parentNode.replaceChild(n,e)}}),(n.innerText||n.textContent).replace(/\s+/g," ").replace(/# /g,"\n# ").replace(/## /g,"\n## ").replace(/### /g,"\n### ").replace(/\.\s+/g,".\n\n").replace(/- /g,"\n- ").replace(/\* /g,"\n* ").split("\n").map(e=>e.trim()).join("\n").replace(/\n{3,}/g,"\n\n").trim()};Plugins.getBinProjectDetails=async({noteId:e})=>{const t=await MineTm.getMinePluginBasedSecretAsync("jamieTmBinProjectDetailsApiKey");try{const i=await fetch("http://localhost:3033/api/bin/getProjectDetails",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:t,noteId:e})});return(await i.json()).data}catch(e){return"Error: "+e}},Plugins.recallFromChat=async(e=[])=>{const t=(await MineTm.getCurrentChatIdbMetaAsync()).idbe,i="User already has full memory access",n=t.messages;if(0===t.chatParams.contextLimit)return i;const s=Math.max(0,n.length-t.chatParams.contextLimit),a=n.slice(0,s);if(!a.length)return i;const o=a.map(t=>{let i=t.content[0].text||t.content;return"user"===t.role&&(i=i.split("\nSystem metadata")[0].trim()),e.every(e=>new RegExp(`\\b${e}\\b`,"i").test(i))?`[${"user"===t.role?"user":MineTm.appNameLong}]\n${i}`:null}).filter(Boolean).join("\n\n---\n\n");return jamie.addPendingMsg(`Chat snippets recall for "${e.join(", ")}": """`+o.split("\n").join(" ")+'"""'),"Recalled and sent to users"},Plugins.searchGoogle=async e=>{const t=await MineTm.getMinePluginBasedSecretAsync("jamieTmGoogleSearchApiKey"),i=async(e,i=1)=>{const n=e+" ".repeat(i-1),s=`https://www.googleapis.com/customsearch/v1?key=${t}&cx=d261072238985400e&q=${encodeURIComponent(n)}`,a=await fetch(s);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const o=await a.json();if(!o?.items?.length)throw new Error("No results found");return o.items.map(e=>({title:e?.title||"",snippet:e?.snippet||"",link:e?.link||""}))};try{if(!e?.query)throw new Error("Invalid request: query parameter required");let t;for(let n=1;n<=5;n++)try{return JSON.stringify(await i(e.query,n),null,2)}catch(e){t=e,console.warn(`Attempt ${n} failed:`,e.message)}return[{error:!0,message:t.message,attempts:5,timestamp:(new Date).toISOString()}]}catch(e){return console.error("Search failed:",e.message),[{error:!0,message:e.message,timestamp:(new Date).toISOString()}]}},Plugins.interpretJavascriptLogs=async code=>{const logs=[],isolatedCode=`\n(function(){\nconst console = {\n  log: function(...args) {\n    logs.push(args.map(arg => String(arg)).join(' '));\n  }\n};\n${code}\n})();\n`.trim();return await eval(isolatedCode),logs},Plugins.getPersonalFinanceInfo=async()=>{const e=await MineTm.getMinePluginBasedSecretAsync("jamiePersonalFinanceKey");try{const t=await fetch("https://pepperpotts.fly.dev/personal-finance/summary",{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":e}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(e){throw console.error("Error:",e),e}},Plugins.sendTextMessageToUser=async e=>{const t=`https://sum-notifier.vercel.app/api/v1/notify?message=${encodeURIComponent(e)}&proxy=Pepper`;let i=!1;return await fetch(t,{mode:"no-cors"}).catch(()=>i=!0),!i},Plugins.favoriteThisChat=async()=>await MineTm.favoriteCurrentChatAsync();class Jamie{#u;#h=[];#p=!1;#m="jamie_passive_mode";#g={};#T=!1;async init(e){return!!this.#T||(this.#u=await e(),!!this.#u&&(this.#p="false"!==localStorage.getItem(this.#m),this.#g={},this.updateOverlayIcon(),!0))}static pluginModes={ALL:"ALL",PASSIVE:"PASSIVE",ACTIVE:"ACTIVE"};extractMaybeFirstJamieCommand(e){if(!e)return null;if(!e.includes("```jamie")&&!e.includes("```Jamie"))return null;const t=e.match(/(?:^|\n)```[jJ]amie\n(.*?)(?:\n```(?:\n|$))/s);return t?t[1]:null}updateOverlayIcon(){Mine.qs("#mineJamieModeStatusButton")?.classList.toggle("active",this.#p)}disablePassiveMonitoring(){this.#p=!1,localStorage.setItem(this.#m,"false"),this.updateOverlayIcon()}enablePassiveMonitoring(){this.#p=!0,localStorage.setItem(this.#m,"true"),this.updateOverlayIcon()}promptToDoWhatAiAsked="Hey Jamie, please do what the AI just requested. Only consider what was said to you in the (`Jamie`) block.";plugins={searchGoogle:{mode:Jamie.pluginModes.ALL,description:"Make an advanced Google search",input_schema:{type:"object",properties:{query:{type:"string",description:"Search query (advanced operators are allowed)"}},required:["query"]},handler:async({query:e})=>await Plugins.searchGoogle({query:e})},scrapeWebsite:{mode:Jamie.pluginModes.ALL,description:"Get text content of a particular website",input_schema:{type:"object",properties:{url:{type:"string",description:"Website url"}},required:["url"]},handler:async({url:e})=>await Plugins.getWebpageTextAsync({url:e}).catch(()=>"Plugin errored")},searchContextFromChats:{mode:Jamie.pluginModes.ACTIVE,description:"Search for context information about a topic across all previous chat threads, and send it to the user directly",input_schema:{type:"object",properties:{titleTerms:{type:"array",description:"Full list of string keywords the context title must contain (in any order, case insensitive)"}},required:["titleTerms"]},handler:async({titleTerms:e})=>await Plugins.getContextFromAChat(e)},getCurrentChatStatsAsync:{mode:Jamie.pluginModes.ACTIVE,description:"Get analytics and chat stats for current chat thread",input_schema:{type:"object",properties:{},required:[]},handler:async({titleTerms:e})=>await Plugins.getCurrentChatStatsAsync(e)},getRecentCalendarEventsAsync:{mode:Jamie.pluginModes.ACTIVE,description:"Get user calendar events around now",input_schema:{type:"object",properties:{},required:[]},handler:async()=>await Plugins.getRecentCalendarEventsAsync()},runJavascriptInterpreterAsync:{mode:Jamie.pluginModes.ALL,description:"Run JavaScript code to get console.log responses",input_schema:{type:"object",properties:{code:{type:"string",description:"JavaScript code to execute. Do NOT attempt network calls. Plugin returns all 'console.log' statements as plugin output."}},required:["code"]},handler:async({code:e})=>await Plugins.interpretJavascriptLogs(e)},getUserPersonalFinanceOverview:{mode:Jamie.pluginModes.ACTIVE,description:"Get user's personal finance overview",input_schema:{type:"object",properties:{},required:[]},handler:async()=>await Plugins.getPersonalFinanceInfo()},syncUploadCurrentChatCall:{mode:Jamie.pluginModes.ACTIVE,description:"Upload the current chat/call by syncing it",input_schema:{type:"object",properties:{},required:[]},handler:async()=>await MineTm.copyCurrentChatToServerAsync()},sendTextMessageToUser:{mode:Jamie.pluginModes.ACTIVE,description:"Send a text message to the user",input_schema:{type:"object",properties:{message:{type:"string",description:"The body of the text message"}},required:["message"]},handler:async({message:e})=>await Plugins.sendTextMessageToUser(e)},getPersonalNotesContents:{mode:Jamie.pluginModes.ACTIVE,description:"Search for the entire contents of a personal Note (also known as a 'Bin Project'). Returns Note contents along with some metadata.",input_schema:{type:"object",properties:{noteId:{type:"string",description:"Exact Note id (title) to search for"}},required:["noteId"]},handler:async({noteId:e})=>await Plugins.getBinProjectDetails({noteId:e})},favoriteCurrentChat:{mode:Jamie.pluginModes.ACTIVE,description:"Mark the current chat as Favorite",input_schema:{type:"object",properties:{},required:[]},handler:async()=>await Plugins.favoriteThisChat()}};async getAlreadyKnownJamieThingsBlob(){if(!MineTm.getCurrentChatId())return"";const e=(await MineTm.getCurrentChatIdbMetaAsync()).idbe;let t=e.chatParams.contextLimit??0;0===t&&(t=1e5),t=Math.min(t,25);return e.messages.slice(-1*t).filter(e=>"user"===e.role).map(e=>{return(t=MineTm.getIdbeMessageObjText(e),t.split("\n").find(e=>e.trim().startsWith("* Jamie: "))?.substring(9).trim()||"")?.trim();var t}).filter(Boolean).join("\n")}async getRecentTranscript(e){return MineTm.getCurrentChatId()?(await MineTm.getCurrentChatIdbMetaAsync()).idbe.messages.slice(-1*(e===Jamie.pluginModes.ACTIVE?8:2)).map(e=>{const t=e.role,i=("user"===e.role?"user":MineTm.appNameLong).toUpperCase();let n=MineTm.getIdbeMessageObjText(e);return"user"===t&&(n=n.split("\nSystem metadata")[0].trim()),`[${i}]\n${n}`}).join("\n\n\n"):""}async playWorkingSoundAsync(){}setWorkingSoundFn(e){this.playWorkingSoundAsync=e}addPendingMsg(e){this.#h.push(e)}async processMsgsAsync(){if(!this.#p)return;const e=await this.getJamieIntelAsync(Jamie.pluginModes.PASSIVE);e&&this.#h.push(e)}get pendingMessagesForAssistant(){return[...this.#h]}markAllAsSent(){this.#h.length=0}getMaybeActivePrefetchRequestId(){return this.#g.requestId}async prefetchRequestAsync(e,t,i){this.#g.requestId=t,this.#g.command=i,this.#g.status="in_progress",this.#g.data=null;const n=await this.getJamieIntelAsync(e,{requestId:t,doCacheBust:!0}).catch(e=>"[error] "+e.toString());this.#g.requestId===t&&(this.#g.status="done",this.#g.data=n)}async getJamieIntelAsync(e,{additionalUserMessage:t="",requestId:i=null,doCacheBust:n=!1}={}){if(!n&&this.#g.requestId===i)return await Mine.waitFor(()=>"done"===this.#g.status,{timeoutMs:6e4,recheckIntervalMs:500}),this.#g.data;const s=await MineTm.getTaAsync();s.classList.toggle("jamieProcessing",!0);let a=await jamie.getRecentTranscript(e);t&&(a+=`\n\n[USER]\n${t}`);const o=`\nYou are Jamie, a fact-checking information-enriching data lookup and verification agent with access to various tools.\n\nGiven this chat excerpt in Live mode (using imperfect speech to text):\n"""\n${a}\n"""\n\nGiven this is already known by ther chatters:\n"""\n${await this.getAlreadyKnownJamieThingsBlob()}\n"""\n\nUser profile:\n* Austin, Texas\n* ${getCurrentTimeFormatted()}\n\nResearch using tools (as applicable), then write a code block (\`\`\`) using the tool results with concise bullet points and precise data, including:\n* New data or calculations performed\n* Brief corrections if necessary\n* Any actions taken for the user\n\nNo analysis, no advice. Just data that has been verified using tools. If you do not have new or valuable intel, say just "n/a" in the code block with no comment.\n`.trim(),{msg:r,usedTools:c}=await this.fetchAnthropicMessage([{role:"user",content:o}],e);if(s.classList.toggle("jamieProcessing",!1),!c)return"";const l=Jamie.getLastCodeBlock(r)?.trim();return l?"n/a"===l.toLowerCase()?"":l:""}static getLastCodeBlock(e){const t=e.split("\n"),i=t.findLastIndex(e=>e.startsWith("```"));if(-1===i)return null;const n=t.findLastIndex((e,t)=>t<i&&e.startsWith("```"));return-1===n?null:t.slice(n+1,i).join("\n").trim()}async fetchAnthropicMessage(e,t){const i=Object.entries(this.plugins).filter(([e,i])=>[Jamie.pluginModes.ALL,t].some(e=>i.mode===e)).map(([e,t])=>{const{mode:i,...n}=t;return{name:e,...n}}),n={model:"claude-sonnet-4-0",temperature:1,stream:!1,messages:e,max_tokens:4096,system:`System time: ${getCurrentTimeFormatted()}`,tools:i},s=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json",accept:"*/*","accept-language":"en-US,en;q=0.9","anthropic-dangerous-direct-browser-access":"true","anthropic-version":"2023-06-01","x-api-key":this.#u},body:JSON.stringify(n)}).then(e=>e.json()),a=s.content.filter(e=>"tool_use"===e.type);if(a.length){const i=a.map(({name:e,input:t,id:i})=>this.plugins[e].handler(t).then(e=>({type:"tool_result",tool_use_id:i,content:[{type:"text",text:safeSerializeAny(e)}]})));t===Jamie.pluginModes.ACTIVE&&this.playWorkingSoundAsync().then();const n=await Promise.all(i);return e.push({role:"assistant",content:s.content},{role:"user",content:n}),{msg:(await this.fetchAnthropicMessage(e,t)).msg,usedTools:!0}}return{msg:s.content[0]?.text||"(no reply, presumed success)",usedTools:!1}}}const TTSCache={db:null,CACHE_NAME:"mine_TTSCache",STORE_NAME:"mine_audioClips",MAX_CACHE_SIZE_MB:50,async init(){return this.db?this.db:new Promise((e,t)=>{const i=indexedDB.open(this.CACHE_NAME,1);i.onerror=()=>t(new Error("Failed to open IndexedDB")),i.onsuccess=()=>{this.db=i.result,e(this.db)},i.onupgradeneeded=e=>{e.target.result.createObjectStore(this.STORE_NAME,{keyPath:"text"})}})},async get(e){return await this.init(),new Promise((t,i)=>{const n=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME),s=n.get(e);s.onerror=()=>i(new Error("Failed to retrieve from cache")),s.onsuccess=()=>{s.result&&n.put({...s.result,timestamp:Date.now()}),t(s.result)}})},async set(e,t){return await this.init(),new Promise((i,n)=>{const s=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME).put({text:e,audioData:t,timestamp:Date.now()});s.onerror=()=>n(new Error("Failed to cache audio")),s.onsuccess=()=>{this.manageSize(),i()}})},async deletePhrasesWithPrefix(e){return await this.init(),new Promise((t,i)=>{const n=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME),s=n.openCursor();let a=0;const o=e=>e.toLowerCase().trim(),r=o(e);s.onerror=()=>i(new Error("Failed to scan cache")),s.onsuccess=e=>{const i=e.target.result;if(!i)return t(a);o(i.value.text||"").startsWith(r)&&(n.delete(i.key),a++),i.continue()}})},async manageSize(){await this.init();const e=this.db.transaction([this.STORE_NAME],"readwrite").objectStore(this.STORE_NAME),t=e.getAll(),i=1024*this.MAX_CACHE_SIZE_MB*1024;t.onsuccess=()=>{let n=t.result,s=n.reduce((e,t)=>e+t.audioData.byteLength,0);if(s>i)for(n.sort((e,t)=>e.timestamp-t.timestamp);s>i&&n.length>0;){const t=n.shift();e.delete(t.text),s-=t.audioData.byteLength}}}},numLeadingSlotsToPrefetch=5;Mine.isi("\n.mineSpeechOutAudio {\n  position: fixed;\n  left: 50%;\n  top: 25px;\n  transform: translateX(-50%);\n  zIndex: 1000;\n  transition: all 0.2s;\n  opacity: 0;\n  pointer-events: none;\n}\n.mineSpeechOutAudio.visible {\n  pointer-events: auto;\n  opacity: 1;\n}\n");const getIsSpeechOutVisible=()=>MineTmAudio.speechAudio.classList.contains("visible"),toggleSpeechOutVisibility=()=>{const e=!getIsSpeechOutVisible();MineTmAudio.speechAudio.classList.toggle("visible",e),Mine.qs("#mineToggleAiSpeechVisibility")?.classList.toggle("active",e)},MineTmAudio={apiKey:"",isAudioInitialized:!1,audioQueue:[],isPlaying:!1,speechAudio:null,isInGeminiMode:null,prebufferSlots:Array(numLeadingSlotsToPrefetch+2).fill().map(()=>({text:null,response:null})),clearPrebufferSlots:()=>MineTmAudio.prebufferSlots.forEach(e=>{e.text=null,e.response=null}),speakStartPreloadAsync:async(e,t=!1)=>{if(MineTmAudio.prebufferSlots.some(t=>t.text===e))return;const i=MineTmAudio.prebufferSlots.findIndex(e=>!e.text);if(i<0)throw"unexpected no prebuffer slots open";const n=MineTmAudio.prebufferSlots[i];n.text=e,n.response=MineTmAudio.generateTtsStreamStart(e,{optimizeLatency:t})},audioBlobCache:new Map,playAudioFileAsync:async(e,t=1)=>{MineTmAudio.initializeSpeechAudioElement();const i=`https://pepperpotts.fly.dev/sounds/${e}`;return new Promise((e,t)=>{const n=()=>{MineTmAudio.speechAudio.removeEventListener("ended",n),e(),MineTmAudio.playNext()};MineTmAudio.speechAudio.addEventListener("ended",n),MineTmAudio.speechAudio.src=i,MineTmAudio.speechAudio.play()})},playNext:async()=>{if(MineTmAudio.audioQueue.length>0&&!MineTmAudio.isPlaying){MineTmAudio.isPlaying=!0;const e=MineTmAudio.audioQueue.shift();"function"==typeof e&&e()}else MineTmAudio.isPlaying=!1},initializeSpeechAudioElement:async()=>{MineTmAudio.speechAudio||(MineTmAudio.speechAudio=new Audio,MineTmAudio.speechAudio.controls=!0,MineTmAudio.speechAudio.controlsList="noplaybackrate nodownload",MineTmAudio.speechAudio.className="mineSpeechOutAudio",document.body.appendChild(MineTmAudio.speechAudio),MineTmAudio.speechAudio.addEventListener("ended",()=>MineTmAudio.playNext()),MineTmAudio.speechAudio.addEventListener("error",e=>{console.error("Audio playback error:",e),MineTmAudio.isPlaying=!1,MineTmAudio.playNext()}),MineTmAudio.speechAudio.addEventListener("play",()=>{}),MineTmAudio.speechAudio.addEventListener("playing",()=>{}))},generateTtsStreamStart:async(e,{optimizeLatency:t=!1,speakingRate:i=1.2,openaiVoiceModel:n="nova"}={})=>{const s=await TTSCache.get(e);if(s)return new Response(s.audioData);if(MineTmAudio.isInGeminiMode){const t=(localStorage.getItem("TM_useGeminiAPIKey")||"").replace(/"/g,"");t||Mine.toastError("no gemini key found in app");const n=`https://texttospeech.googleapis.com/v1/text:synthesize?key=${t}`,s=["en-US-Chirp3-HD-Aoede","en-US-Chirp3-HD-Laomedeia","en-US-Chirp3-HD-Sulafat","en-US-Chirp3-HD-Achernar"],a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:{text:e},voice:{languageCode:"en-US",name:s[0]},audioConfig:{audioEncoding:"MP3",speakingRate:i}})});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const o=await a.json(),r=atob(o.audioContent),c=new Uint8Array(r.length);for(let e=0;e<r.length;e++)c[e]=r.charCodeAt(e);return new Response(c,{headers:{"Content-Type":"audio/mp3"}})}{const t={model:"tts-1",voice:n,input:e,response_format:"mp3",speed:i,stream:!0},s=10;for(let e=0;e<s;e++){const i=await fetch("https://api.openai.com/v1/audio/speech",{method:"POST",headers:{Authorization:`Bearer ${MineTmAudio.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok){if(i.status>=500&&i.status<600&&e<s-1){await Mine.sleep(100*Math.pow(2,e));continue}throw new Error(`HTTP error! status: ${i.status}`)}return e&&console.log(`[TTS] Success on attempt ${e+1}`),i}}},stopLocalSpeaking:()=>{window.speechSynthesis.cancel()},speakAsync:async(e,{startPepperActivitySoundAsync:t=Mine.noop,stopPepperActivitySoundAsync:i=Mine.noop,isCacheCandidate:n=!1,speakingRate:s=1.2,openaiVoiceModel:a="shimmer"}={})=>new Promise(async(o,r)=>{const c=n&&e.split(" ").length<=5;await MineTmAudio.initializeSpeechAudioElement();let l=!1;const d=()=>{l||(i(),MineTmAudio.speechAudio.src.startsWith("blob:")&&URL.revokeObjectURL(MineTmAudio.speechAudio.src),l=!0)};try{let n,l=!0;setTimeout(()=>l&&t(),100);const u=MineTmAudio.prebufferSlots.findIndex(t=>t.text===e&&t.response);if(u>=0){const e=MineTmAudio.prebufferSlots[u];n=await e.response.catch(()=>null),e.text=null,e.response=null}else console.log(`Prebuffer cache miss "${e.substring(0,5)}..."`),n=await MineTmAudio.generateTtsStreamStart(e,{speakingRate:s,openaiVoiceModel:a});if(l=!1,!n)return d(),r("Error with response");MineTmAudio.speechAudio.setAttribute("data-current-message",e);const h=n.body.getReader();if("undefined"!=typeof ManagedMediaSource){const t=[];for(;;){const{done:e,value:i}=await h.read();if(e)break;t.push(i)}const i=new Blob(t,{type:"audio/mpeg"});if(MineTmAudio.speechAudio.src=URL.createObjectURL(i),await MineTmAudio.speechAudio.play(),c){const t=new Uint8Array(await i.arrayBuffer());await TTSCache.set(e,t),TTSCache.manageSize()}}else{const t=new MediaSource;MineTmAudio.speechAudio.src=URL.createObjectURL(t),MineTmAudio.speechAudio.play();const i=[];t.addEventListener("sourceopen",async()=>{const n=t.addSourceBuffer("audio/mpeg");for(;;){const{done:e,value:t}=await h.read();if(e)break;i.push(t),await new Promise(e=>{n.appendBuffer(t),n.addEventListener("updateend",e,{once:!0})})}if(t.endOfStream(),c){const t=new Uint8Array(i.reduce((e,t)=>[...e,...t],[]));await TTSCache.set(e,t),TTSCache.manageSize()}})}MineTmAudio.speechAudio.onplaying=()=>i(),MineTmAudio.speechAudio.onpause=()=>{d(),o()},MineTmAudio.speechAudio.onended=()=>{MineTmAudio.speechAudio.removeAttribute("data-current-message"),d(),o()}}catch(e){console.error("Error while speaking:",e),d(),r(e)}}),initializeAudioOnUserInteraction:async({waitForInteraction:e=!0,enableSpeechOutput:t=!0}={})=>{if(MineTmAudio.isAudioInitialized)return Promise.resolve();if(t&&!MineTmAudio.isInGeminiMode&&(MineTmAudio.apiKey=await MineTm.getMinePluginBasedSecretAsync("jamieOpenAiApiKey"),!MineTmAudio.apiKey))throw"no openai api key";if(e)return new Promise(e=>{const t=["touchstart","touchend","click"],i=()=>MineTmAudio.initializeSpeechAudioElement().then(()=>{MineTmAudio.isAudioInitialized=!0,t.forEach(e=>document.body.removeEventListener(e,i)),e()});t.forEach(e=>document.body.addEventListener(e,i,{once:!0}))});await MineTmAudio.initializeSpeechAudioElement().then(()=>MineTmAudio.isAudioInitialized=!0)}};window.MineTmAudio=MineTmAudio,MineTmAudio.speakTextAsync=async(e,{enableCaching:t=!1,speakingRate:i=1,openaiVoiceModel:n="nova"}={})=>{await MineTmAudio.initializeAudioOnUserInteraction({waitForInteraction:!1,enableSpeechOutput:!0}),MineTmAudio.speechAudio?.pause(),MineTmAudio.stopLocalSpeaking(),await MineTmAudio.speakAsync(prepMarkdownForTts(e),{isCacheCandidate:t,speakingRate:i,openaiVoiceModel:n})};class CalendarMonitor{#u;#h=[];#y=new Set;async init(e){return this.#u=await e(),!!this.#u&&(await this.refresh(),this.#M(),!0)}async refresh(){const e=(await this.#S()).filter(e=>!this.#y.has(e)&&!this.#h.includes(e));this.#h.push(...e)}markAllAsSent(){this.#h.forEach(e=>this.#y.add(e)),this.#h.length=0}get pendingMessagesForAssistant(){return[...this.#h]}static async getRecentCalendarEventsAsync(e){const t=Date.now(),i=Intl.DateTimeFormat().resolvedOptions().timeZone,n=await fetch("https://pepperpotts.fly.dev/cal/getRecentCalendarWindow",{method:"POST",headers:{"Content-Type":"application/json","pepper-api-key":e},body:JSON.stringify({now:t,timezone:i})});if(!n.ok)throw new Error("Calendar fetch failed");const{success:s,events:a}=await n.json();if(!s)throw new Error("Calendar fetch failed");return a}async#S(){return await CalendarMonitor.getRecentCalendarEventsAsync(this.#u)}#M(){const e=new Date,t=6e4*(5-e.getMinutes()%5)-1e3*e.getSeconds();setTimeout(()=>{this.refresh(),setInterval(()=>this.refresh(),3e5)},t)}}const PHRASES={MUTE_PHRASES_LOWER:["mute me","mute","toggle mute"].map(e=>e.toLowerCase()),STOP_PHRASES_LOWER:["turn off","turn off turn off","enough","enough enough","enough enough enough","hold on a sec","hold on a second","hold on","hold-on a sec","hold-on a second","hold-on","quit","shut the fuck up","shut up","shut-up","silence","silent","stop","stop stop","stop stop stop","wait a sec","wait a second","wait"].map(e=>e.toLowerCase()),SHORT_SAYINGS_MISC_LOWER:["hello","hey","hi","status","time","pepper","go"].map(e=>e.toLowerCase()),NEW_CONVERSATION_PHRASES_LOWER:["forget conversation","forget this conversation","let's start a new conversation","lets start a new conversation","reset conversation","reset this conversation","start a new conversation","start new conversation"].map(e=>e.toLowerCase())};let audioContext;PHRASES.quickResponsePhrasesLower=[...PHRASES.MUTE_PHRASES_LOWER,...PHRASES.STOP_PHRASES_LOWER,...PHRASES.SHORT_SAYINGS_MISC_LOWER,...PHRASES.NEW_CONVERSATION_PHRASES_LOWER],MineTm.liveMode={},MineTm.liveMode.isCallMuted=!1,MineTm.liveMode.SttModes={PHONE_CALL:1,PUSH_TO_TALK:2,PUSH_TO_TRANSCRIBE:3,SPEAKER:4};const SoundKit={_playAudioOnceAsync:async e=>{const t=await fetch(`https://pepperpotts.fly.dev/sounds/${e}`),i=await t.arrayBuffer(),n=await audioContext.decodeAudioData(i);return new Promise(e=>{const t=audioContext.createBufferSource();t.buffer=n,t.connect(audioContext.destination),t.onended=()=>e(),t.start(0)})},sendingMessageAsync:async()=>await SoundKit._playAudioOnceAsync("happy-pop-3.mp3"),ackAsPositiveAsync:async()=>await SoundKit._playAudioOnceAsync("ack-positive.mp3"),ackAsNegativeAsync:async()=>await SoundKit._playAudioOnceAsync("ack-negative.mp3"),ackAsNoopAsync:async()=>await SoundKit._playAudioOnceAsync("blunt.mp3"),ackWithKeyboard:async()=>await SoundKit._playAudioOnceAsync("keyboard-typing-blip.mp3"),paperCrumple:async()=>await SoundKit._playAudioOnceAsync("paper-crumple.mp3"),muteOn:async()=>await SoundKit._playAudioOnceAsync("mute-on.mp3"),muteOff:async()=>await SoundKit._playAudioOnceAsync("mute-off.mp3"),noAiResponse:async()=>await SoundKit._playAudioOnceAsync("no-ai-response.mp3"),callDropped:async()=>await SoundKit._playAudioOnceAsync("call-dropped.mp3"),callEnded:async()=>await SoundKit._playAudioOnceAsync("call-ended.mp3")},renderMuteStatus=()=>Mine.qs("#mineMuteStatusButton")?.classList.toggle("active",!MineTm.liveMode.isCallMuted);let latestProcessUserMessageTimestampMs=null;MineTm.liveMode.toggleMuteAsync=async({interruptSpeech:e=!1,onlyEnable:t=!1}={})=>{const i=!t&&!MineTm.liveMode.isCallMuted;MineTm.liveMode.isCallMuted=i,document.body.classList.toggle("isListening",!MineTm.liveMode.isCallMuted),renderMuteStatus(),MineTm.liveMode.isCallMuted?SoundKit.muteOn():(SoundKit.muteOff(),e&&(latestProcessUserMessageTimestampMs=null))};const jamie=new Jamie;MineTm.haltAnyCurrentActivityIdempotently=()=>{MineTm.getStopButton()?.click(),MineTmAudio.speechAudio.pause(),Mine.qsaa("audio").filter(e=>!e.paused).forEach(e=>setAudioVolumeSmoothlyNoopAsync(e,0).then(()=>e.pause())),MineTmAudio.stopLocalSpeaking()};const beginLiveModeTitleLangId="Begin Live mode";MineTm.liveMode.getInitPrompt=(e=!1)=>`\n"""${beginLiveModeTitleLangId}\n\nGuidelines:\n* Keep responses concise (almost to the point of brevity)\n* Your messages may be processed via Text-to-speech\n* Speech-To-Text/Text-To-Speech is choppy\n* Emphasize using basic bold, italics, and horizontal rules\n${e?"* Provide anxiety-reducing companionship":""}\n* Speak conversationally in sentences\n* No bullet lists.\n* No literal emojis (😊, 🎉, etc.) — use textual interjections instead (haha, hmm, etc.)\n* User messages will automatically contain relevant system messages appended\n* Jamie sometimes provides real-time data/calculations embedded in the user's system messages (will be attributed to Jamie). Incorporate Jamie's feedback and corrections when applicable, citing Jamie.\n* If the user asks you to have Jamie do something, put your concise message to Jamie in a code block using the "\`\`\`jamie" language identifier to invoke Jamie.\n"""\n`.trim();const prepMarkdownForTts=e=>{let t=e;t=t.replace(/\*\*(.*?)\*\*/g,(e,t)=>` - ${t.toUpperCase()} - `),t=t.replace(/__(.*?)__/g,(e,t)=>` - ${t.toUpperCase()} - `),t=t.replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g,"*$1*"),t=t.replace(/(?<!_)_([^_]+?)_(?!_)/g,"*$1*");const i=t.split("\n"),n=[];for(let e=0;e<i.length;e++){const t=i[e].trim(),s="---"===t||"***"===t||"___"===t;!s||s&&e===i.length-1?s||n.push(i[e]):n.push("    ")}return t=n.join("\n"),t=t.replace(/```(\w+)[\s\S]*?```/gi,(e,t)=>`. some ${t.toUpperCase()} code.`).replace(/ → /g," points to "),t=(e=>(e=e.replace(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})([ap]m)/gi,(e,t,i,n)=>`${t} to ${i} ${n.toUpperCase()}`)).replace(/(\d{1,2}:\d{2})([ap]m)/gi,(e,t,i)=>`${t} ${i.toUpperCase()}`))((e=>(e=(e=e.replace(/(^|[\s(])\$(\d+(?:\.\d+)?)[Mm]\b/g,(e,t,i)=>`${t}${i} million dollars`)).replace(/(^|[\s(])\$(\d+(?:\.\d+)?)[Kk]\b/g,(e,t,i)=>`${t}${i} thousand dollars`)).replace(/\b(\d+)\.(\d+)%/g,(e,t,i)=>`... ${t} point ${i.split("").join(" ")} percent`))(t)),t.trim()};MineTm.initGoLiveAsync=async({mode:e=MineTm.liveMode.SttModes.PHONE_CALL,speakOutput:t=!0,triggeredViaDirectUserInteraction:i=!1}={})=>{const n=MineTm.Mine;MineTm.isMobile&&(n.qs('[data-element-id="chat-input-actions"]').style.maxHeight="100px");const s=await MineTm.getCurrentChatIdbMetaAsync();MineTmAudio.isInGeminiMode=s?.idbe&&s.idbe.modelInfo.id.toLowerCase().startsWith("gemini-");const[a,o]=await Promise.all([MineTmAudio.initializeAudioOnUserInteraction({enableSpeechOutput:t,waitForInteraction:!i}),(async()=>{const e=await MineTm.getMinePluginBasedSecretAsync("pepperContextNodesApiKey");if(!e)return"";const t=async(t,i,n=null)=>{const s={method:i,headers:{"Content-Type":"application/json",apiKey:e}};return n&&(s.body=JSON.stringify(n)),fetch(`https://pepperpotts.fly.dev${t}`,s).then(e=>e.json()).catch(()=>({error:`unable to load data from ${t}`}))},[i,n]=await Promise.all([t("/api/bin/getRecentContextNodesMeta","POST",{}),t("/api/health/sleepInfo","POST")]),s={recentProjects:i,lastSleepInfo:n,locationInfo:await(async()=>fetch("https://sum-location.vercel.app/api/v1/status",{headers:{"X-Api-Key":await MineTm.getMinePluginBasedSecretAsync("locationApiKey")}}).then(e=>e.json()).then(e=>{for(const t in e)for(const i in e[t])i.endsWith("Ms")&&delete e[t][i];return e}).catch(e=>(console.error("Error:",e),{error:"could not fetch location data"})))(),currentDevice:MineTm.isMobile?"mobile phone":"laptop",currentAppOrigin:window.location.origin};return`"""User context\n${JSON.stringify(s,null,2)}\n"""`})()]),r=async()=>await MineTm.sendMessageAsync(MineTm.liveMode.getInitPrompt()+`\n\n${o}`.trim(),{sendOnlyAndPreventResponse:!0});if(MineTm.getCurrentChatId()){const e=(await MineTm.getCurrentChatIdbMetaAsync()).idbe;e.messages.some(e=>"user"===e.role&&MineTm.getIdbeMessageObjText(e).trim().split("\n")[0].endsWith(beginLiveModeTitleLangId))?e.messages.some(e=>"user"===e.role&&MineTm.getIdbeMessageObjText(e).includes(o))||o&&await MineTm.sendMessageAsync(o,{sendOnlyAndPreventResponse:!0}):await r()}else await r();await n.waitFor(()=>MineTm.getCurrentChatId(),{timeoutMs:15e3,recheckIntervalMs:500});const c=await n.waitFor(async()=>await MineTm.getCurrentChatIdbMetaAsync(),{recheckIntervalMs:1e3}),l=c.idbe.chatParams?.contextLimit;let d="";if(l){const e=t=>{const{numMsgs:i}=t.detail;return i>=l?(d="Passed max chat lookback context limit",void document.removeEventListener("numMsgsInChatChanged",e)):l-i<=5?(d="Approaching max chat lookback context limit",void document.removeEventListener("numMsgsInChatChanged",e)):void 0};document.addEventListener("numMsgsInChatChanged",e)}const u=new CalendarMonitor;MineTmAudio.isInGeminiMode||(setTimeout(()=>u.init(async()=>await MineTm.getMinePluginBasedSecretAsync("jamieTmMinePepperKey")).then(e=>e||n.toastError("No Pepper key")),5e3),setTimeout(()=>{jamie.init(async()=>await MineTm.getMinePluginBasedSecretAsync("jamieTmAnthropicKey")).then(e=>e||n.toastError("No Jamie key"))},1e3)),MineTm.Experiments.FEAT_EAVESDROPPER_TTS&&(async()=>{const e=window.fetch;window.fetch=async function(t,i){const n=await e.apply(this,arguments);if(t.includes("https://api.anthropic.com/v1/messages")){const e=n.clone().body.getReader(),t=new TextDecoder,i=e=>document.dispatchEvent(new CustomEvent("FEAT_EAVESDROP",{detail:e}));(async()=>{try{for(;;){const{done:n,value:s}=await e.read();if(n)break;const a=t.decode(s,{stream:!0}).split("\n");for(const e of a){if(!e.startsWith("data: ")||e.includes("[DONE]"))continue;const t=JSON.parse(e.slice(6));"message_start"===t.type&&i({stage:"start",data:t}),"content_block_delta"===t.type&&"thinking_delta"===t.delta?.type&&i({stage:"thought",data:t}),"content_block_delta"===t.type&&"text_delta"===t.delta?.type&&i({stage:"text",data:t,text:t.delta.text}),"message_stop"===t.type&&i({stage:"stop",data:t})}}}catch(e){i({stage:"abort",data:{error:e.name}})}})()}else if(t.includes("https://api.openai.com/v1/chat/completions")){const e=n.clone().body.getReader(),t=new TextDecoder,i=e=>document.dispatchEvent(new CustomEvent("FEAT_EAVESDROP",{detail:e}));(async()=>{try{for(;;){const{done:n,value:s}=await e.read();if(n)break;const a=t.decode(s,{stream:!0}).split("\n");let o=!0;for(const e of a){if(!e.startsWith("data: ")||e.includes("[DONE]"))continue;const t=JSON.parse(e.slice(6));if("chat.completion.chunk"!==t.object)continue;o&&(i({stage:"start",data:{}}),o=!1);const n=t.choices?.[0]?.delta?.content;n&&i({stage:"text",data:t,text:n}),"stop"===t.choices?.[0]?.finish_reason&&i({stage:"stop",data:t})}}}catch(e){i({stage:"abort",data:{error:e.name}})}})()}else if(t.includes("https://generativelanguage.googleapis.com/")){const e=n.clone().body.getReader(),t=new TextDecoder,i=e=>document.dispatchEvent(new CustomEvent("FEAT_EAVESDROP",{detail:e}));let s=!0;(async()=>{try{for(;;){const{done:n,value:a}=await e.read();if(n)break;const o=t.decode(a,{stream:!0}).split("\n");for(const e of o){if(!e.startsWith("data: ")||e.includes("[DONE]"))continue;const t=JSON.parse(e.slice(6)),n=t.candidates?.[0]?.content?.parts?.[0]?.text;if(n){s&&(i({stage:"start",data:{}}),s=!1);const e=t.candidates?.[0]?.content?.parts?.[0]?.thought;i({stage:e?"thought":"text",data:t,text:n})}"STOP"===t.candidates?.[0]?.finishReason&&i({stage:"stop",data:t})}}}catch(e){i({stage:"abort",data:{error:e.name}})}})()}return n}})(),MineTm.isMobile&&(window.onerror=(e,t,i,n,s)=>(Plugins.sendTextMessageToUser(`Pepper call | error: ${e} ${t} ${s.toString()}`),!1),window.addEventListener("unhandledrejection",e=>{const t=e.reason;let i={message:t?.toString()||"Unknown error",stack:t?.stack||"No stack trace available",timestamp:(new Date).toISOString(),url:window.location.href,additionalInfo:{}};if(t instanceof Error&&Object.getOwnPropertyNames(t).forEach(e=>{i.additionalInfo[e]=t[e]}),window.React&&window.React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED)try{i.reactInfo="React detected on page"}catch(e){i.reactError=e.toString()}console.error("Unhandled Promise Rejection:",i);const n=JSON.stringify(i,null,2);Plugins.sendTextMessageToUser(`Pepper call | Unhandled Rejection:\n${n}`),e.preventDefault()})),(async()=>{if(MineTm.getStopButton()?.click(),!await(async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0});return e=await STTWidget.switchToAirPodsIfAvailableAsync(e),e}catch(e){return null}})())return MineTm.Mine.toast("Need mic permissions");MineTm.isMobile&&MineTm.Mine.toast("ℹ️ turn on guided access");const i="girl-humming.mp3",s="elevator-waiting.mp3";let a;(()=>{const e="https://pepperpotts.fly.dev/sounds/",t={[i]:new Audio(`${e}${i}`),[s]:new Audio(`${e}${s}`)};Object.values(t).forEach(e=>{e.loop=!0}),startPepperActivitySoundAsync=async(e=i)=>{await stopPepperActivitySoundAsync(),t[e].play().then()},stopPepperActivitySoundAsync=async()=>{Object.values(t).forEach(e=>{e.pause(),e.currentTime=0})}})();const o=async()=>{a?.isConnected||(a=await MineTm.getTaAsync())};await o();const c=async()=>{const e=MineTm.getStopButton();e&&(e.click(),await n.waitFor(()=>!MineTm.getStopButton()))};let l=!1;const h=async e=>{await c();const t=[e],i='\n---\n"""System metadata (not directly visible to user)';t.push(i);const s=MineTmAudio.speechAudio.getAttribute("data-current-message");if(s){const e=s.trim().split(" ").slice(0,3).join(" ");t.push(`* ⚠️ [interruption] User interrupted and didn't hear anything starting at "${e}"`)}if(!MineTm.isMobile&&n.Extension){let e;const i=e=>e.replace(/^https?:\/\//,"").replace(/^www\./,""),s=e=>e.replace(/\/$/,"");try{e=await(n.Extension.getCurrentFocusedTabUrl?.()),e=e||"",e=i(e),e=s(e)}catch(e){}e&&t.push(`* active site: ${e}`)}d&&!l&&(t.push(`* ⚠️ [warning] ${d}`),l=!0);const a=u.pendingMessagesForAssistant;a.length&&t.push(`* 🗓️ [Calendar event notice] ${a.map(e=>`"${e}"`).join("; ")}`),jamie.pendingMessagesForAssistant.forEach(e=>t.push(`* Jamie: ${e.split("\n").map(e=>e.trim()).filter(Boolean).join(" ")}`)),t[t.length-1]===i?t.pop():t.push('"""'),await o(),await MineTm.sendMessageAsync(t.join("\n")).catch(e=>{throw MineTm.Mine.toastError("Unable to send"),e}),u.markAllAsSent(),jamie.markAllAsSent()};jamie.setWorkingSoundFn(async()=>await SoundKit.ackWithKeyboard()),await MineTmAudio.playAudioFileAsync("call-start.mp3"),MineTm.isMobile&&(toggleSpeechOutVisibility(),MineTm,toggleSpeechOutVisibility());const p=["nevermind","never mind","never-mind"].map(e=>e.toLowerCase()),m=["J.B.","Jay","Jamey","Jami","Jamie","Janet","Janey","Janie","Jay me","Jeannie","Jenny","Jimmi","Jimmie","Jimmy"].map(e=>e.toLowerCase()).map(e=>[`${e}`,`hey ${e}`,`play ${e}`]).flat(),g=e=>e.replace(/[^a-zA-Z\s]/g,""),T={};document.body.classList.toggle("isListening",!MineTm.liveMode.isCallMuted),MineTm.liveMode.sttWidget=new STTWidget({speakOutput:t,onUserSpeechPhraseStartAsync:async()=>{latestProcessUserMessageTimestampMs=null,MineTm.haltAnyCurrentActivityIdempotently()},onUserSpeechPhraseFinishAsync:async({text:e})=>{latestProcessUserMessageTimestampMs=null,MineTm.haltAnyCurrentActivityIdempotently(),[MineTm.liveMode.SttModes.PUSH_TO_TALK,MineTm.liveMode.SttModes.SPEAKER].includes(MineTm.liveMode.sttWidget?.mode)&&MineTm.liveMode.toggleMuteAsync(),await(async(e,i)=>{const a=(await MineTm.getCurrentChatIdbMetaAsync()).idbe.messages.length;let o=!0;if(["disable jamie","disabled jamie"].includes(g(e.toLowerCase().trim())))jamie.disablePassiveMonitoring(),SoundKit.ackAsPositiveAsync(),o=!1;else if("enable jamie"===g(e.toLowerCase().trim()))jamie.enablePassiveMonitoring(),SoundKit.ackAsPositiveAsync(),o=!1;else if(m.some(t=>g(e.toLowerCase().trim()).startsWith(t))){await SoundKit.ackWithKeyboard();const t=await jamie.getJamieIntelAsync(Jamie.pluginModes.ACTIVE,{additionalUserMessage:e,requestId:T.id});t||(t="(no comment)");const i=e+`\n\n\n---\nSystem attachment (not directly visible to user):\n"""jamiesIntel\n${t}\n"""`;await h(i),o=!0}else if(PHRASES.STOP_PHRASES_LOWER.some(t=>e.toLowerCase().trim()===t)||p.some(t=>e.toLowerCase().trim().endsWith(t))||["hey siri,","hey siri.","hey siri "].some(t=>e.toLowerCase().trim().startsWith(t)))SoundKit.ackAsNoopAsync(),MineTm.getStopButton()?.click(),await stopPepperActivitySoundAsync(),o=!1;else if(PHRASES.MUTE_PHRASES_LOWER.some(t=>e.toLowerCase().trim()===t))await MineTm.liveMode.toggleMuteAsync(),o=!1;else if(PHRASES.NEW_CONVERSATION_PHRASES_LOWER.some(t=>[t,t.replace(/conversation/g,"convo"),t.replace(/conversation/g,"condo")].includes(e.trim().replace(/'/g,"").toLowerCase()))){await c();const e=n.qs('[data-element-id="clear-context-button"]');e?(e.click(),await r(),await SoundKit.paperCrumple(),o=!1):await SoundKit.ackAsNegativeAsync()}else 1!==e.trim().split(" ").length||PHRASES.SHORT_SAYINGS_MISC_LOWER.some(t=>e.toLowerCase()===t)||e.trim().startsWith("$")||e.trim().endsWith("%")?(SoundKit.sendingMessageAsync(),await h(`"""🎙️ ${MineTm.getHumanizedTimeLabel()}\n${e}\n"""`)):(SoundKit.ackAsNoopAsync(),o=!1);if(o)if(MineTm.Experiments.FEAT_EAVESDROPPER_TTS){const e=setTimeout(()=>!i()&&startPepperActivitySoundAsync(s),3e3),a=()=>{clearTimeout(e),stopPepperActivitySoundAsync()},o=Date.now();T.id=o,T.accumulatedText="",T.state="pending";const r=()=>document.removeEventListener("FEAT_EAVESDROP",l),c=()=>document.dispatchEvent(new CustomEvent("CURRENT_AI_RESPONSE_MSG_DATA_UPDATED")),l=e=>{if(T.id!==o)return void r();const{stage:t,text:i}=e.detail;"start"===t?(a(),T.state="started",c()):"text"===t?(T.accumulatedText+=i,T.state="texting",c()):"stop"!==t&&"abort"!==t||(T.state="stop"===t?"finished_streaming":"aborted",c(),r())};document.addEventListener("FEAT_EAVESDROP",l),t&&await(async e=>new Promise(async t=>{const i=T.id,s=Symbol("msg-fully-consumed"),a=[];let o=!1;const r=["[,.!?:;]",...["and","but","because","so","for","since"].map(e=>`\\s${e}(?=\\s)`),"\\s[-—](?=\\s)","\\n"].join("|"),c=new RegExp(`(?<=${r})\\s`),l=/(?<=[.!?])\s+/,d=()=>{const e=a.findIndex(e=>e===s),t=-1!==e?e:Math.min(numLeadingSlotsToPrefetch,a.length);for(let e=0;e<t;e++)MineTmAudio.speakStartPreloadAsync(a[e])};MineTmAudio.clearPrebufferSlots(),(async()=>{let t=!1;for(;!e()&&T.id===i&&"aborted"!==T.state;){let e=!1;if(a.length){if(a[0]===s){t=!0;break}const i=a.shift();if(d(),!/[a-zA-Z0-9]/.test(i))continue;await MineTmAudio.speakAsync(i,{startPepperActivitySoundAsync,stopPepperActivitySoundAsync,isCacheCandidate:!o,speakingRate:1.2}).catch(e=>SoundKit.noAiResponse()),e=!0,o=!0}e||await Promise.race([n.sleep(100),new Promise(e=>document.addEventListener("PHRASE_TO_SPEAK_QUEUE_ADDED",e,{once:!0}))])}return{spokeEverythingUninterrupted:t,spokenTextRaw:T.accumulatedText}})().then(async({spokeEverythingUninterrupted:e,spokenTextRaw:t=""})=>{if(!e)return;const{idbe:i}=await MineTm.getCurrentChatIdbMetaAsync();!MineTm.getIdbeMessageObjText(i.messages.reverse().find(e=>"user"===e.role)).includes(jamie.promptToDoWhatAiAsked)&&t.toLowerCase().includes("```jamie".toLowerCase())?document.dispatchEvent(new CustomEvent("FakeSpeechContextText",{detail:{text:jamie.promptToDoWhatAiAsked}})):MineTm.liveMode.sttWidget?.mode===MineTm.liveMode.SttModes.SPEAKER&&(await n.sleep(1e3),MineTm.liveMode.toggleMuteAsync({onlyEnable:!0}))});const u=t=>{if(!e()){if(t===s)return a.push(t),document.dispatchEvent(new CustomEvent("PHRASE_TO_SPEAK_QUEUE_ADDED")),void d();if(a.length<=numLeadingSlotsToPrefetch)a.push(t),document.dispatchEvent(new CustomEvent("PHRASE_TO_SPEAK_QUEUE_ADDED"));else{const e=a.length-1;a[e]=[a[e],t].join(" "),a[e]=a[e].split(l).filter(e=>(e=>{const t=e.trim(),i=t.substring(0,t.length-1);return!(["Anything else you need help with","Let me know how I can help","What can I do for you","Is there anything else you","I'm here to assist you","How can I assist you","I'm here to help","Is there anything else you'd like","Feel free to","Please feel free to"].some(e=>i.startsWith(e))||i.startsWith("If ")&&["how I can help",", just let me know",", let me know",", just reach out","feel free to reach out","feel free to share","feel free to ask"].some(e=>i.endsWith(e)))})(e)).join(" ")}d()}};let h=-1;const p=async()=>{if(e())return;const t=jamie.extractMaybeFirstJamieCommand(T.accumulatedText);t&&jamie.getMaybeActivePrefetchRequestId()!==T.id&&jamie.prefetchRequestAsync(Jamie.pluginModes.ACTIVE,T.id,t).then();const i=prepMarkdownForTts(T.accumulatedText).split(c).filter(e=>e.trim());if(["texting","started","pending"].includes(T.state)){const e=new RegExp(`${r}$`),t=i.findIndex(t=>!e.test(t.trim()));t>0&&(i.slice(h+1,t).forEach(e=>u(e)),h=t-1),await(async()=>{await Promise.race([n.sleep(100),new Promise(e=>document.addEventListener("CURRENT_AI_RESPONSE_MSG_DATA_UPDATED",e,{once:!0}))]),await p()})()}else"finished_streaming"===T.state&&(i.slice(h+1).forEach(e=>u(e)),h=i.length-1,u(s),jamie.processMsgsAsync())};await p(),t()}))(i)}else{const e=a+2,o=setTimeout(()=>!i()&&startPepperActivitySoundAsync(s),3e3);let r;try{await Promise.race([n.waitForQs('[data-element-id="streaming-block"] [data-element-id="response-block"]',{recheckIntervalMs:100,timeoutMs:1/0}),MineTm.waitForCompletedMsgCountAsync(e,3e5),new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout")),3e5))]),r=!0}catch(e){if("Timeout"!==e.message)throw e;r=!1}if(clearTimeout(o),stopPepperActivitySoundAsync(),i())return void MineTm.getStopButton()?.click();if(!r)return void SoundKit.noAiResponse();const c=MineTm.getAllUserResponseBlocks().slice(-1)[0],l="message-index-",d=Number([...c.closest(`[class*="${l}"]`).classList].find(e=>e.startsWith(l)).split(l)[1]);t&&await beginSpeakEntireMessageFractionallyViaDomAsync(d+1,i)}})(e,()=>null!==latestProcessUserMessageTimestampMs)},mode:e}),MineTm.liveMode.sttWidget.initListeningForeverAsync()})(),window.addEventListener("del-tts-by-prefix",async()=>{const e=prompt("Enter prefix to delete:");if(!e?.trim())return;const t=await TTSCache.deletePhrasesWithPrefix(e);alert(`Deleted ${t} cached phrases`)})};class BarListener{constructor(){this.recognition=null,this.isListening=!1,this.shouldStay=!1,this.restartTimeout=null,this.initRecognition(),document.addEventListener("numMsgsInChatChanged",async e=>{MineTm.barListenerRequestedOnIdle&&"user"!==e.detail.lastMessage?.role&&Mine.qsaa('[data-element-id="ai-response"]').pop().scrollIntoView({behavior:"smooth"})})}initRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)throw new Error("Speech recognition not supported in this browser");this.recognition=new e,this.recognition.continuous=!0,this.recognition.interimResults=!1,this.recognition.lang="en-US",this.recognition.maxAlternatives=1,this.recognition.onresult=e=>{"bar"===e.results[e.results.length-1][0].transcript.trim().toLowerCase()&&(MineTm.PushToTalk.toggleRecordingLockAsync(),this.stop())},this.recognition.onerror=e=>{console.error("Speech recognition error:",e.error),["no-speech","aborted"].includes(e.error)&&this.shouldStay?this.scheduleRestart():"not-allowed"===e.error&&(console.error("Microphone permission denied"),this.isListening=!1,this.shouldStay=!1)},this.recognition.onend=()=>{this.isListening=!1,this.shouldStay&&this.scheduleRestart()}}scheduleRestart(){this.restartTimeout&&clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout(()=>{this.shouldStay&&this.startRecognition()},100)}startRecognition(){if(!this.isListening)try{this.isListening=!0,this.recognition.start()}catch(e){this.isListening=!1,this.shouldStay&&this.scheduleRestart()}}async listenForBarAsync(){this.shouldStay=!0,this.startRecognition()}stop(){this.shouldStay=!1,this.isListening=!1,this.restartTimeout&&clearTimeout(this.restartTimeout),this.recognition&&this.recognition.stop()}}MineTm.barListener=new BarListener,MineTm.barListenerRequestedOnIdle=!1,MineTm.PushToTalk={pushToTalkState:{isPttPhysicallyBeingHeld:!1,isRecordingLockActive:!1,lastSpaceTimeMs:0,pttSttWidget:null,heardEvents:[],holdStartTimeMs:null,getCurrentLocationPromise:null,lastLocationFetchTimeMs:null},toggleRecordingLockAsync:async(e,t=!1)=>{e||(e=await MineTm.getTaAsync()),MineTm.PushToTalk.pushToTalkState.isRecordingLockActive?(MineTm.PushToTalk.pushToTalkState.isRecordingLockActive=!1,e.classList.toggle("recording-lock",!1),await MineTm.PushToTalk.finishRecordingAsync({enablePlugins:t})):(MineTm.PushToTalk.pushToTalkState.isRecordingLockActive=!0,e.classList.toggle("recording-lock",!0),await MineTm.PushToTalk.startRecordingAsync({isDoubleTap:!0}))},startRecordingAsync:async({isDoubleTap:e=!1}={})=>{const t=await MineTm.getTaAsync(),i=Date.now();(!MineTm.PushToTalk.pushToTalkState.lastLocationFetchTimeMs||i-MineTm.PushToTalk.pushToTalkState.lastLocationFetchTimeMs>3e5)&&(MineTm.PushToTalk.pushToTalkState.getCurrentLocationPromise=MineTm.getMaybeCurrentLocationNameAsync(),MineTm.PushToTalk.pushToTalkState.lastLocationFetchTimeMs=i),await MineTmAudio.initializeAudioOnUserInteraction({waitForInteraction:!1,enableSpeechOutput:!1}),t.classList.toggle("recording",!0),MineTm.PushToTalk.pushToTalkState.pttSttWidget=new STTWidget({onUserSpeechPhraseFinishAsync:({text:e,richPhrases:i,lastPhraseStartTimestampMs:n})=>{if(["over","over."].includes(e.trim().toLowerCase())&&MineTm.PushToTalk.pushToTalkState.isRecordingLockActive)return MineTm.PushToTalk.toggleRecordingLockAsync(),void(MineTm.barListenerRequestedOnIdle&&setTimeout(()=>MineTm.barListener.listenForBarAsync(),500));MineTm.PushToTalk.pushToTalkState.heardEvents.push({text:e,richPhrases:i,receivedMs:Date.now(),lastPhraseStartTimestampMs:n}),(MineTm.PushToTalk.pushToTalkState.isPttPhysicallyBeingHeld||MineTm.PushToTalk.pushToTalkState.isRecordingLockActive)&&(()=>{const e="speech-activity-indicator";t.classList.remove(e),t.classList.add(e),setTimeout(()=>t.classList.remove(e),1e3)})()},onUserSpeechPhraseStartAsync:Mine.noop,useNoiseDetection:!1,mode:MineTm.liveMode.SttModes.PUSH_TO_TRANSCRIBE,startMinimized:!0}),MineTm.PushToTalk.pushToTalkState.pttSttWidget.initListeningForeverAsync()},finishRecordingAsync:async({enablePlugins:e=!1}={})=>{const t=await MineTm.getTaAsync();if(t.classList.toggle("recordingReleasedAndFinalizing",!0),MineTm.PushToTalk.pushToTalkState.pttSttWidget.getNetSpokenCompiled()&&(await Mine.waitFor(()=>!MineTm.PushToTalk.pushToTalkState.pttSttWidget.getNetSpokenCompiled(),{timeoutMs:3e5}),await Mine.sleep(100)),await MineTm.PushToTalk.pushToTalkState.pttSttWidget.dieAsync(),t.classList.toggle("recording",!1),t.classList.toggle("recordingReleasedAndFinalizing",!1),t.classList.toggle("recording-lock",!1),!MineTm.PushToTalk.pushToTalkState.heardEvents.length)return;const i=document.getSelection()?.toString()?.trim()||"",n=MineTm.mapEachNonEmptyLine(i,e=>`> ${e}`),s=e=>{if(e<0)return"?";const t=Math.floor(e/60),i=e%60;return t>0?`${t}m:${String(i).padStart(2,"0")}s`:`${i}s`},a=MineTm.PushToTalk.pushToTalkState.heardEvents.map((e,t)=>((e,t,i,n)=>{if(MineTm.isMobile){const a=n[0].lastPhraseStartTimestampMs,o=Math.floor((e.lastPhraseStartTimestampMs-a)/1e3),r=Math.floor((e.receivedMs-a)/1e3),c=`[${s(o)}-${s(r)}] `;return(0!==i||t?c:"")+e.text}return e.richPhrases?.length?e.richPhrases.map(e=>{const t=Math.floor(e.relativeEndTimestampMs/1e3),i=!!e.relativeMaybeStartTimestampMs,n=i?Math.floor(e.relativeMaybeStartTimestampMs/1e3):null,a=[i?`${s(n)}-${s(t)}`:`?-${s(t)}`];return e.confidence&&e.confidence<.8&&e.alternatives?.length&&a.push(`${Math.round(100*(1-e.confidence))}% unintelligible`),`[${a.join(", ")}] ${e.text}`}).join("\n"):t?.richPhrases?.length&&t.richPhrases.map(e=>e.text).join(" ").trim().startsWith(e.text.trim())?null:e.text})(e,MineTm.PushToTalk.pushToTalkState.heardEvents[t+1],t,MineTm.PushToTalk.pushToTalkState.heardEvents)).filter(e=>null!==e).join("\n").trim(),o=MineTm.PushToTalk.pushToTalkState.heardEvents.map(e=>e.text).join("\n").trim().toLowerCase();if(MineTm.PushToTalk.pushToTalkState.heardEvents.length=0,["never mind","never mind.","never-mind","never-mind.","nevermind","nevermind."].some(e=>o.endsWith(e)))return;const r=await(MineTm.PushToTalk.pushToTalkState.getCurrentLocationPromise?.catch(()=>null));MineTm.PushToTalk.pushToTalkState.getCurrentLocationPromise=null;let c=`"""🎤 ${MineTm.getHumanizedTimeLabel()}${r?` at ${r}`:""}${MineTm.isMobile?" on 📱":" on 💻"}\n${a}\n"""\n`;if(!i&&!t.value){o.includes("jamie")&&(c+="\n"+Mine.normalizeSpaceIndents('\n          """System message\n          Note (if applicable): You may invoke Jamie (an assistant agent) in your response to the user by also including a command block (```Jamie) with a concise request. Then Jamie will reply as a followup.\n          """'));const t=await MineTm.sendMessageAsync(c,{returnAiResponse:!0,enablePlugins:e});if(jamie.extractMaybeFirstJamieCommand(t)){const{idbe:e}=await MineTm.getCurrentChatIdbMetaAsync();if(e.modelInfo.id.toLowerCase().startsWith("gemini-"))await MineTm.sendMessageAsync("```System message\nUnfortunately, Jamie is not accessible in the current system environment.\n```");else{await jamie.init(async()=>await MineTm.getMinePluginBasedSecretAsync("jamieTmAnthropicKey")).then(e=>e||Mine.toastError("No Jamie key"));const e=await jamie.getJamieIntelAsync(Jamie.pluginModes.ACTIVE,{additionalUserMessage:jamie.promptToDoWhatAiAsked});await MineTm.sendMessageAsync(`\`\`\`Jamie intel\n${e}\n\`\`\``)}}return}Mine.updateReactTypableFormValue(t,(t.value?`${t.value.trim()}\n\n`:"")+(n?`${n.trim()}\n`:"")+c),t.focus(),t.scrollTo({top:t.scrollHeight,behavior:"smooth"})}};const initPushToTranscribeAsync=async()=>{const e=new Set(["Tab"," "]),t=new Set(["ShiftRight"]),i=async i=>{const n=e.has(i.key)||t.has(i.code);if(!n)return;const s=["INPUT","TEXTAREA"].includes(i.target.tagName),a=await MineTm.getTaAsync();if(!n||!s||i.target===a&&(""===a.value||a.selectionStart===a.value.length&&a.value.endsWith("\n"))){if((" "===i.key||"ShiftRight"===i.code)&&"keydown"===i.type&&!i.repeat){const e=Date.now(),t="ShiftRight"===i.code?"ShiftRight":"Space";MineTm.PushToTalk.pushToTalkState.lastKeyTimes=MineTm.PushToTalk.pushToTalkState.lastKeyTimes||{};const n=e-(MineTm.PushToTalk.pushToTalkState.lastKeyTimes[t]||0)<250;if(MineTm.PushToTalk.pushToTalkState.lastKeyTimes[t]=e,n&&!MineTm.PushToTalk.pushToTalkState.isRecordingLockActive)return i.preventDefault(),void await MineTm.PushToTalk.toggleRecordingLockAsync(a);if(!n&&MineTm.PushToTalk.pushToTalkState.isRecordingLockActive){i.preventDefault();const e=i.shiftKey&&"ShiftRight"!==i.code;return void await MineTm.PushToTalk.toggleRecordingLockAsync(a,e)}}if(MineTm.PushToTalk.pushToTalkState.isRecordingLockActive)n&&"keydown"===i.type&&i.preventDefault();else{if(i.preventDefault(),"keydown"===i.type&&!MineTm.PushToTalk.pushToTalkState.isPttPhysicallyBeingHeld&&!i.repeat)return MineTm.PushToTalk.pushToTalkState.isPttPhysicallyBeingHeld=!0,MineTm.PushToTalk.pushToTalkState.holdStartTimeMs=Date.now(),await MineTm.PushToTalk.startRecordingAsync(),void(MineTm.PushToTalk.pushToTalkState.lockTimer=setTimeout(async()=>{MineTm.PushToTalk.pushToTalkState.isPttPhysicallyBeingHeld&&(MineTm.PushToTalk.pushToTalkState.isRecordingLockActive=!0,a.classList.toggle("recording-lock",!0))},15e3));if("keyup"===i.type&&MineTm.PushToTalk.pushToTalkState.isPttPhysicallyBeingHeld){if(MineTm.PushToTalk.pushToTalkState.isPttPhysicallyBeingHeld=!1,MineTm.PushToTalk.pushToTalkState.lockTimer&&clearTimeout(MineTm.PushToTalk.pushToTalkState.lockTimer),MineTm.PushToTalk.pushToTalkState.isRecordingLockActive)return;const e=i.shiftKey;await MineTm.PushToTalk.finishRecordingAsync({enablePlugins:e})}}}};["keydown","keyup"].forEach(e=>document.addEventListener(e,i))};!MineTm.isMobile&&initPushToTranscribeAsync()})();